# 问题四：数据驱动的磁芯损耗预测模型 解决方案说明

**贡献者:** @Noir-ZE
**最后更新时间:** 2025-09-01

---

## 1. 问题解析与核心目标

本部分旨在解决赛题中的**问题四：构建一个数据驱动的磁芯损耗预测模型**。

核心目标是开发一个能够**跨越所有工况**（不同材料、温度、频率和波形）进行高精度磁芯损耗预测的机器学习回归模型。此模型旨在克服传统物理模型（如问题二中的SE/MSE）在处理复杂、非正弦激励和多因素耦合影响时的局限性，提供一个更通用、更精确的预测工具。

## 2. 核心思路与技术方案

我们采用经典的**监督学习回归 (Supervised Learning Regression)** 范式，通过构建一个强大的梯度提升树模型来解决此问题。整体技术路线分为三个核心模块：

1.  **综合特征工程 (`4_1_feat_engi.py`)**: 这是模型成功的基石。我们不再依赖简化的物理方程，而是从原始数据中提取一个全面的、信息丰富的特征集。这个特征矩阵将所有已知的工况参数（如温度、频率）和从 `B(t)` 动态行为中派生的物理及形态学特征（如 `Bm`, `max(dB/dt)`, `Kurtosis` 等）融为一体，为模型提供全方位的信息输入。

2.  **模型训练与评估 (`4_2_train_eval.py`)**:
    *   **模型选择**: 选用业界领先的 **LightGBM (Light Gradient Boosting Machine)** 回归器。它以其卓越的预测精度、极高的训练效率和对大规模、高维度数据的强大处理能力而著称。
    *   **科学评估**: 采用 **10-折交叉验证 (10-Fold Cross-Validation)** 对模型的预测精度（R², RMSE, MAPE）和泛化能力进行严谨、稳健的评估。
    *   **洞察分析**: 利用模型训练后输出的**特征重要性**排名，识别对磁芯损耗影响最大的关键因素，为工程实践提供数据驱动的指导。

3.  **预测与结果生成 (`4_3_pred_gene.py`)**: 将在全部训练数据上训练好的最终模型应用于附件三的测试样本，生成预测结果，并按赛题要求格式化输出。

## 3. 特征工程：模型的感知系统

我们为模型构建了一个包含三类信息的综合特征矩阵，使其能够“理解”不同的工况：

| 特征类别 | 特征名称 | 设计原理与在模型中的作用 |
| :--- | :--- | :--- |
| **基础工况** | `Frequency`, `Temperature` | 直接输入模型，作为最基本的物理条件。 |
| **分类工况** | `Material` & `Waveform_Type` 的 **One-Hot编码** | 将离散的类别（如 '材料1', '正弦波'）转化为模型可以处理的数值特征，避免了引入不存在的序数关系。 |
| **B(t)派生特征** | **`Bm` (峰值磁通密度)** | 核心物理量，与磁滞损耗直接相关。 |
| | **`max(dB/dt)` (最大磁通变化率)** | 核心物理量，与涡流损耗直接相关。 |
| | **`Kurtosis` (峭度)** & **`THD` (总谐波失真)** | 复用问题一中被证明极为有效的波形形态特征。它们帮助模型区分不同波形下的非线性损耗，并捕捉其对总损耗的复杂影响。 |

这个特征体系将所有分散的信息整合起来，使模型能够学习到不同因素之间复杂的、非线性的相互作用。

## 4. 脚本文件说明

本解决方案包含三个独立的Python脚本，请务必按顺序执行。

### `4_1_feat_engi.py`
*   **功能**: 特征工程模块。
*   **输入**: `train_data_combined.csv` (来自问题一), `Test_Data_3.xlsx`。
*   **处理**:
    1.  加载训练集和测试集。
    2.  对两个数据集应用完全相同的特征提取流程，计算 `Bm`, `max_dB_dt`, `Kurtosis`, `THD` 等。
    3.  对分类特征 `Material` 和 `Waveform_Type` 执行 One-Hot 编码。
*   **输出**:
    *   `q4_train_featured.csv`: 包含完整特征和目标变量的训练文件。
    *   `q4_test_featured.csv`: 包含完整特征的测试文件。

### `4_2_train_eval.py`
*   **功能**: 模型训练、评估与保存模块。
*   **输入**: `q4_train_featured.csv`。
*   **处理**:
    1.  加载特征化后的训练数据，并对目标变量 `Core_Loss` 进行对数变换以优化训练。
    2.  执行10折交叉验证，打印详细的性能评估指标（R², RMSE, MAPE）。
    3.  在全部训练数据上训练最终模型。
    4.  分析并绘制特征重要性图 (`feature_importance.png`)。
*   **输出**:
    *   `lgbm_model.pkl`: 训练好的、可随时用于预测的最终模型文件。
    *   `feature_importance.png`: 展示各特征对模型预测贡献大小的可视化图表。

### `4_3_pred_gene.py`
*   **功能**: 应用模型进行预测并生成最终结果。
*   **输入**: `q4_test_featured.csv`, `lgbm_model.pkl`。
*   **处理**:
    1.  加载测试数据和训练好的模型。
    2.  执行预测，并将对数尺度的预测结果逆变换回原始尺度。
    3.  生成包含所有测试样本预测值的完整结果文件 (`q4_predictions.csv`)。
    4.  按题目要求，筛选特定样本的预测结果，生成专用于论文的表格 (`q4_predictions_for_paper.csv`)。
*   **输出**:
    *   `q4_predictions.csv`: 完整的预测结果。
    *   `q4_predictions_for_paper.csv`: 可直接用于报告的、包含特定样本结果的CSV文件。

## 5. 如何运行 (Step-by-Step Guide)

### 步骤 1: 环境准备
请确保您的Python环境中已安装以下必要的库：
```bash
pip install pandas numpy scikit-learn lightgbm joblib matplotlib seaborn tqdm openpyxl
```

### 步骤 2: 数据准备
*   请确保在运行本部分之前，**已经成功运行了问题一的 `1_1_data_prep.py`**，并生成了 `train_data_combined.csv` 文件。
*   将 `train_data_combined.csv` 和 `Test_Data_3.xlsx` 文件与本问题的三个Python脚本放置在同一目录下。

### 步骤 3: 依次执行脚本
打开终端或命令行，进入脚本所在目录，然后按以下顺序执行脚本：

1.  **执行特征工程**
    ```bash
    python 4_1_feat_engi.py
    ```
    *运行成功后，会生成 `q4_train_featured.csv` 和 `q4_test_featured.csv` 两个文件。*

2.  **执行模型训练与评估**
    ```bash
    python 4_2_train_eval.py
    ```
    *运行成功后，会打印交叉验证的详细评估结果，并生成 `lgbm_model.pkl` 和 `feature_importance.png`。*

3.  **执行预测并生成结果**
    ```bash
    python 4_3_pred_gene.py
    ```
    *运行成功后，会生成 `q4_predictions.csv` 和 `q4_predictions_for_paper.csv` 两个最终结果文件。*

---
至此，问题四的全部求解流程已完成。我们构建了一个高精度、高泛化能力的数据驱动模型，为磁芯损耗的预测提供了强大的现代化工具。